<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Lector continuo (USB/Bluetooth HID) → Ruta</title>
<link rel="preconnect" href="https://unpkg.com"/>
<style>
  :root{--bg:#0b0f14;--card:#121822;--ink:#e6edf3;--muted:#9fb0c8;--ok:#1db954;--err:#ff5c5c;--accent:#2d9cdb}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0b0f14,#0f1622);color:var(--ink)}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  h1{font-size:20px;margin:0 0 10px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
  .card{background:var(--card);border:1px solid #1d2838;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type=file],button,input[type=text],label.pill{border-radius:12px;border:1px solid #2a3750;background:#0c121b;color:var(--ink);padding:10px 12px}
  input[type=text]{min-width:300px;font-size:18px}
  button{cursor:pointer}
  .status{margin-top:10px;border-radius:12px;padding:12px;font-weight:700}
  .ok{background:rgba(29,185,84,.14);border:1px solid rgba(29,185,84,.35)}
  .err{background:rgba(255,92,92,.14);border:1px solid rgba(255,92,92,.35)}
  .warn{background:rgba(45,156,219,.14);border:1px solid rgba(45,156,219,.35)}
  .muted{color:var(--muted)}
  .table{width:100%;border-collapse:collapse;margin-top:8px}
  .table th,.table td{border-bottom:1px solid #243043;padding:6px;text-align:left}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0c121b;border:1px solid #2a3650;color:#9fb0c8;font-size:12px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;min-width:260px;max-width:90vw;padding:12px 14px;border-radius:12px;font-weight:700;box-shadow:0 8px 30px rgba(0,0,0,.35);z-index:9999}
  .toast.ok{background:rgba(29,185,84,.98);color:#fff}
  .toast.err{background:rgba(255,92,92,.98);color:#fff}
  .hint{font-size:13px;color:var(--muted)}
  /* KPIs resumen CSV */
  .kpi-row{display:flex;gap:10px;flex-wrap:wrap;align-items:stretch;margin-top:10px}
  .kpi{flex:1 1 180px;background:#0c121b;border:1px solid #2a3750;border-radius:12px;padding:10px 12px}
  .kpi .title{font-size:12px;color:#9fb0c8;margin-bottom:4px}
  .kpi .value{font-weight:800;font-size:20px;line-height:1}
</style>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Lector continuo (USB/Bluetooth HID) → Ruta</h1>
  <div class="muted">
    Conecta el lector como <b>HID (modo teclado)</b>. CSV: <b>Columna A = referencia de manifiesto</b>, <b>Columna B = ID de la ruta</b>.
    Cada escaneo responde automáticamente la ruta. Solo los éxitos se guardan.
  </div>

  <div class="grid">
    <!-- Izquierda: carga CSV + escaneo continuo -->
    <section class="card">
      <!-- Carga CSV -->
      <div class="row">
        <div>
          <label>Planilla (CSV)</label><br/>
          <input id="csv" type="file" accept=".csv,text/csv" />
          <div class="hint">Separador coma. Con o sin encabezado.</div>
        </div>
        <label class="pill"><input type="checkbox" id="beep" checked/> Beep</label>
        <label class="pill"><input type="checkbox" id="vibrate" checked/> Vibrar</label>
        <button id="clear-history">Limpiar historial</button>
        <span id="successCount" class="badge">0 éxitos</span>
      </div>

      <!-- Resumen del CSV -->
      <div id="csv-summary" class="kpi-row" style="display:none">
        <div class="kpi">
          <div class="title">Quantidad de paquetes</div>
          <div class="value" id="kpi-unique-manifests">0</div>
        </div>
        <div class="kpi">
          <div class="title">Quantidad de rutas</div>
          <div class="value" id="kpi-unique-routes">0</div>
        </div>
        <div class="kpi">
          <div class="title">Quantidad de paquetes duplicados</div>
          <div class="value" id="kpi-dup-manifests">0</div>
        </div>
      </div>

      <!-- Escaneo continuo (HID) -->
      <div class="row" style="margin-top:10px">
        <input id="manual" type="text" placeholder="Apunte el lector aquí y escanee..." autocomplete="off" />
      </div>

      <div id="status" class="status warn">Cargue el CSV. Luego comience a escanear. (Sufijo recomendado en el lector: <b>ENTER</b>).</div>

      <div class="hint" style="margin-top:6px">
        Si su lector no envía ENTER, el sistema auto-procesa al detectar una pausa corta entre teclas.
      </div>
    </section>

    <!-- Derecha: historial (solo éxitos) -->
    <aside class="card">
      <strong>Lecturas exitosas</strong>
      <div class="hint">Últimos 20 (los errores no se registran)</div>
      <table class="table" id="history">
        <thead><tr><th>Hora</th><th>Paquete</th><th>Ruta</th></tr></thead>
        <tbody></tbody>
      </table>
    </aside>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
  // ===== Estado =====
  // map: referencia de manifiesto (Col A) -> ID de ruta (Col B)
  let map = new Map();
  let okHistory = [];
  let successCount = 0;

  // Auto-submit si no viene ENTER
  const inactivityMs = 160; // pausa breve típica entre caracteres del lector
  let inactivityTimer = null;

  // Dedupe para evitar doble envío del mismo código
  const dedupeMs = 500;
  let lastCode = ''; let lastWhen = 0;

  const $ = (id)=>document.getElementById(id);
  const statusEl = $('status');
  const toastEl = $('toast');

  function setStatus(msg, kind='warn'){
    statusEl.className = 'status ' + kind;
    statusEl.textContent = msg;
  }
  function toast(msg, kind='ok'){
    toastEl.textContent = msg;
    toastEl.className = 'toast ' + kind;
    toastEl.style.display = 'block';
    setTimeout(()=> toastEl.style.display='none', 1100);
  }
  function beep(){
    if(!$('beep').checked) return;
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type='square'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      o.start();
      setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.05); o.stop(); ctx.close(); }, 110);
    }catch(e){}
  }
  function vibrate(){ if($('vibrate').checked && navigator.vibrate) navigator.vibrate(50); }
  function normalize(x){ return String(x||'').trim(); }

  // ===== CSV (A = manifiesto, B = ruta) =====
  $('csv').addEventListener('change', (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    Papa.parse(f, {
      complete: (res)=>{
        const rows = res.data.filter(r=>r && r.length && r.some(c=>String(c).trim()!==''));
        if(!rows.length){ setStatus('CSV vacío.', 'err'); return; }
        const first = rows[0];
        const hasHeader = first.some(x => isNaN(Number(String(x).trim())) && String(x).trim().length>0);
        const data = hasHeader ? rows.slice(1) : rows;

        map.clear();
        const manifestList = [];
        const routeList = [];
        for(const r of data){
          const manifest = normalize(r[0]); // Col A
          const routeId  = normalize(r[1]); // Col B
          if(manifest){
            map.set(manifest, routeId || '');
            manifestList.push(manifest);
            routeList.push(routeId || '');
          }
        }

        // KPIs (según tu definición)
        const uniqueManifests = new Set(manifestList).size;                  // Quantidad de paquetes
        const uniqueRoutes    = new Set(routeList.filter(x=>x!=='')).size;   // Quantidad de rutas
        const freq = Object.create(null);
        for(const m of manifestList){ freq[m] = (freq[m]||0) + 1; }
        let dupManifests = 0; for(const m in freq){ if(freq[m] > 1) dupManifests += (freq[m]-1); } // Quantidad de paquetes duplicados

        // Mostrar KPIs
        $('kpi-unique-manifests').textContent = uniqueManifests;
        $('kpi-unique-routes').textContent    = uniqueRoutes;
        $('kpi-dup-manifests').textContent    = dupManifests;
        $('csv-summary').style.display = 'flex';

        setStatus(`CSV cargado (${uniqueManifests} paquetes únicos, ${uniqueRoutes} rutas). Comience a escanear.`, 'ok');

        // Asegurar foco continuo para el lector
        focusLoop();
      },
      error: ()=> setStatus('Error al leer el CSV.', 'err')
    });
  });

  // ===== Escaneo continuo (HID) =====
  function processScanValue(){
    const code = normalize($('manual').value);
    if(!code) return;

    // Dedupe rápido
    const now = Date.now();
    if(code === lastCode && (now - lastWhen) < dedupeMs){
      $('manual').value = '';
      return;
    }
    lastCode = code; lastWhen = now;

    handleDetected(code);
    $('manual').value = ''; // listo para el siguiente
    $('manual').focus();
  }

  // ENTER/Tab del lector dispara inmediato
  $('manual').addEventListener('keydown', (ev)=>{
    if(ev.key === 'Enter' || ev.key === 'Tab'){
      ev.preventDefault();
      processScanValue();
    }
  });

  // Si el lector no manda ENTER: auto-procesar tras pausa breve
  $('manual').addEventListener('input', ()=>{
    if(inactivityTimer) clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(processScanValue, inactivityMs);
  });

  // Mantener el foco siempre (flujo continuo de escaneos)
  function focusLoop(){
    $('manual').focus();
    setInterval(()=>{
      if(document.activeElement !== $('manual')) $('manual').focus();
    }, 300);
  }

  // ===== Resultado (historial solo éxitos) =====
  function addSuccess(code, route){
    const tb = $('history').querySelector('tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${new Date().toLocaleTimeString()}</td><td>${code}</td><td>${route}</td>`;
    tb.insertBefore(tr, tb.firstChild);
    while(tb.rows.length>20) tb.deleteRow(tb.rows.length-1);

    okHistory.push({ t:Date.now(), code, route });
    successCount++;
    $('successCount').textContent = `${successCount} éxitos`;
  }

  function handleDetected(codeRaw){
    const code = String(codeRaw).trim();
    const route = map.get(code);
    if(route !== undefined){
      setStatus(`Ruta: ${route || '(sin ruta)'}`, 'ok');
      toast(`✔ ${code} → ${route || '(sin ruta)'}`, 'ok');
      beep(); vibrate();
      addSuccess(code, route || '(sin ruta)');
    }else{
      setStatus('Código no encontrado en el CSV.', 'err');
      toast(`✖ ${code} no encontrado`, 'err');
      beep(); // no se registra el error
    }
  }

  // Limpiar historial
  $('clear-history').addEventListener('click', ()=>{
    $('history').querySelector('tbody').innerHTML = '';
    okHistory = []; successCount = 0;
    $('successCount').textContent = '0 éxitos';
    setStatus('Historial limpiado.', 'warn');
  });
</script>
</body>
</html>
