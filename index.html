<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HID Keyboard Test — Únicos</title>
<style>
  :root{--ink:#0e1726;--muted:#5b6b7c;--card:#f4f7fb;--line:#d7e0ea;--accent:#2d9cdb;--ok:#1db954}
  *{box-sizing:border-box}
  body{margin:0;font:16px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:var(--ink)}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  h1{margin:0 0 8px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin-top:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{display:inline-flex;align-items:center;gap:6px}
  input[type="number"]{width:90px;padding:6px 8px;border:1px solid var(--line);border-radius:8px;background:#fff}
  button{padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .muted{color:var(--muted)}
  .box{font-family:ui-monospace,Consolas,monospace;background:#fff;border:1px dashed var(--line);border-radius:8px;padding:8px}
  .badge{display:inline-block;padding:3px 10px;border-radius:999px;border:1px solid var(--line);background:#fff}
  .badge.ok{border-color:#bfe6c8;background:#eaf9ee;color:#0d6}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
  th{background:#f9fbfe}
</style>
</head>
<body>
<div class="wrap">
  <h1>HID Keyboard Test — Únicos</h1>
  <p class="muted">Escanee con su lector USB/Bluetooth (modo teclado). La tabla solo registra <b>códigos válidos únicos</b>. Presione <b>ENTER</b> para finalizar un código, o active autoflush.</p>

  <div class="card">
    <div class="row">
      <label><input id="beep" type="checkbox" checked> Beep</label>
      <label><input id="autoFlush" type="checkbox"> Auto-procesar en pausa</label>
      <label>Pausa (ms) <input id="flushMs" type="number" value="120" min="40" step="10"></label>
      <label><input id="showKeys" type="checkbox"> Ver eventos de tecla</label>
      <button id="clearAll">Limpiar todo</button>
      <span id="uniqueCount" class="badge ok">0 únicos</span>
    </div>
    <div style="margin-top:8px" class="box">
      <b>Buffer:</b> <span id="buf"></span>
    </div>
    <div style="margin-top:8px" class="box">
      <b>Último scan:</b> <span id="last">—</span>
    </div>
  </div>

  <div class="card">
    <strong>Lecturas únicas</strong>
    <table>
      <thead><tr><th>#</th><th>Código</th><th>Primera vez</th></tr></thead>
      <tbody id="uniqueBody"></tbody>
    </table>
  </div>

  <div class="card" id="keysWrap" style="display:none">
    <strong>Eventos de tecla (debug)</strong>
    <pre id="keys" class="box" style="min-height:120px;white-space:pre-wrap"></pre>
  </div>
</div>

<script>
  // --- configuración / reglas de validez ---
  const DEDUPE_MS = 800;        // evita doble hit inmediato si el haz sigue en el código
  const MIN_LEN   = 4;          // longitud mínima aceptada
  const VALID_RE  = /^[A-Z0-9\-\.\/\+\%\s]+$/i; // alfanumérico + símbolos comunes de Code39/128

  // --- estado ---
  let buffer = '';
  let lastScan = '';
  let lastWhen = 0;
  let timer = null;

  const unique = new Map(); // code -> timestamp (primera vez)

  // --- elementos ---
  const $ = id => document.getElementById(id);
  const bufEl = $('buf'), lastEl = $('last'), keysEl = $('keys'), keysWrap = $('keysWrap');
  const uniqueBody = $('uniqueBody'), uniqueCount = $('uniqueCount');

  // --- utilidades UI ---
  function showBuffer(){ bufEl.textContent = buffer; }
  function logKey(e){
    if(!$('showKeys').checked) return;
    keysWrap.style.display = '';
    keysEl.textContent += `${e.type}: key="${e.key}" code=${e.code}\n`;
    keysEl.scrollTop = keysEl.scrollHeight;
  }
  $('showKeys').addEventListener('change', ()=> keysWrap.style.display = $('showKeys').checked ? '' : 'none');

  function beep(){
    if(!$('beep').checked) return;
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const osc = ctx.createOscillator(), g=ctx.createGain();
      osc.type='square'; osc.frequency.value=880; osc.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
      osc.start();
      setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.05); osc.stop(); ctx.close(); }, 110);
    }catch(_){}
  }

  // --- normalización / validación ---
  function sanitize(s){
    return String(s).replace(/[\r\n\t]/g,'').replace(/[^\x20-\x7E]/g,'').trim();
  }
  function normalizeUpcEan(s){
    // Convierte EAN-13 con 0 inicial a UPC-A (12 dígitos) para evitar duplicados de representación
    if(/^\d{13}$/.test(s) && s.startsWith('0')) return s.slice(1);
    return s;
  }
  function normalizeCode(s){
    s = sanitize(s);
    s = s.replace(/\s+/g,''); // quita espacios internos
    s = normalizeUpcEan(s);
    return s;
  }
  function isValid(code){
    return code.length >= MIN_LEN && VALID_RE.test(code);
  }

  // --- agregar único a la tabla ---
  function addUnique(code){
    if(unique.has(code)) return; // ya registrado (NO duplicamos)
    const ts = new Date();
    unique.set(code, ts);

    const tr = document.createElement('tr');
    const idx = unique.size;
    tr.innerHTML = `<td>${idx}</td><td>${code}</td><td>${ts.toLocaleTimeString()}</td>`;
    // insertar arriba
    uniqueBody.insertBefore(tr, uniqueBody.firstChild);

    uniqueCount.textContent = `${unique.size} únicos`;
  }

  // --- flush de un escaneo ---
  function flush(){
    const raw = buffer; buffer=''; showBuffer();
    let code = normalizeCode(raw);
    if(!isValid(code)) return;

    const now = Date.now();
    if(code === lastScan && (now - lastWhen) < DEDUPE_MS) return; // rebote inmediato
    lastScan = code; lastWhen = now;

    lastEl.textContent = code;
    addUnique(code); // << SOLO únicos
    beep();
  }

  // --- auto-flush (pausa) ---
  function schedule(){
    if(!$('autoFlush').checked) return;
    clearTimeout(timer);
    const ms = Math.max(40, Number($('flushMs').value || 120));
    timer = setTimeout(flush, ms);
  }

  // --- capturas globales (funciona sin foco) ---
  document.addEventListener('keydown', e=>{
    logKey(e);
    if(e.ctrlKey || e.altKey || e.metaKey) return;

    if(e.key === 'Enter' || e.key === 'Tab'){
      e.preventDefault(); flush(); return;
    }
    if(e.key === 'Backspace'){
      buffer = buffer.slice(0,-1); showBuffer(); schedule(); return;
    }
    if(e.key && e.key.length === 1){
      buffer += e.key; showBuffer();
      if(e.key !== ' ') e.preventDefault();
      schedule();
    }
  }, true);

  document.addEventListener('paste', e=>{
    const txt = (e.clipboardData || window.clipboardData).getData('text') || '';
    if(txt){ e.preventDefault(); buffer += txt; showBuffer(); schedule(); }
  });

  // --- controles ---
  $('clearAll').addEventListener('click', ()=>{
    buffer=''; showBuffer(); lastEl.textContent='—';
    unique.clear(); uniqueBody.innerHTML=''; uniqueCount.textContent='0 únicos';
    keysEl.textContent='';
  });

  // init
  showBuffer();
</script>
</body>
</html>
